<!DOCTYPE html><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"><meta http-equiv="Content-Language" content="en"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>LockableStorage</title><link href="dossier.css" rel="stylesheet" type="text/css"><header><div><form><div><input type="search" placeholder="Search" tabindex="1"></div></form></div></header><main><article><div class="parentlink"><b>Namespace:</b> <a href="namespace_e2e_openpgp.html">e2e.openpgp</a></div><div class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l59">View Source</a></div><h1>class LockableStorage</h1><p>Class to provide a storage container optionally encrypted and authenticated
in the persistent storage. Uses any Closure storage mechanism backend.
Encryption and HMAC keys are derived from a passphrase.
If needed, the passphrase is obtained asynchronously via a passphrase
callback function to unlock the container. The container can be locked at
runtime to force prompting for a passphrase before allowing access to the
data.</p>
<h3>new LockableStorage(<wbr>storageMechanism, opt_passphraseCallback, opt_storageKeyName, opt_saltKeyName)</h3><div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>storageMechanism<code>goog.storage.mechanism.Mechanism</code><dd><p>persistent
storage mechanism.</p>
<dt>opt_passphraseCallback<code>function(): <a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>&gt;=</code><dd><p>Callback used to deliver the passphrase.</p>
<dt>opt_storageKeyName<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>=</code><dd><p>The storage&#39;s key under which the user
data is stored in storageMechanism.</p>
<dt>opt_saltKeyName<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>=</code><dd><p>The storage&#39;s key under which the salt is
stored in storageMechanism.</p>
</dl></div></div><h2>Instance Methods</h2><div id="get" class="function"><div><h3>get(<wbr>key)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l457">code »</a></span></h3><p>Retrieves a data stored under a given key. Will trigger unlock() and ask for
a passphrase if needed.</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>key<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a></code><dd><p>Data key</p>
</dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;*&gt;</code><dd><p>Data stored under a given key.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="getMultiple" class="function"><div><h3>getMultiple(<wbr>keys)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l470">code »</a></span></h3><p>Retrieves a data stored under multiple keys. Will trigger unlock() and ask
for a passphrase if needed.</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>keys<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array">Array</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>&gt;</code><dd><p>Data keys</p>
</dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object">Object</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>, *&gt;&gt;</code><dd><p>Data stored under given keys.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="getPassphrase" class="function"><div><h3>getPassphrase()<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l446">code »</a></span></h3><p>Returns a passphrase.</p>
<div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a></code><dd><p>The passphrase.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="isEncrypted" class="function"><div><h3>isEncrypted()<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l211">code »</a></span></h3><p>Checks if persisted storage is encrypted.</p>
<div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean">boolean</a>&gt;</code></dl></div></div></div></div><hr class="fn-sep"><div id="isLocked" class="function"><div><h3>isLocked()<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l283">code »</a></span></h3><p>Checks if the storage is currently locked and needs a passphrase to be
unlocked.</p>
<div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean">boolean</a></code></dl></div></div></div></div><hr class="fn-sep"><div id="lock" class="function"><div><h3>lock()<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l417">code »</a></span></h3><p>Removes the passphrase and the decrypted data from the cache. Storage will
need to be unlocked before the data can be used.</p>
</div></div><hr class="fn-sep"><div id="remove" class="function"><div><h3>remove(<wbr>key)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l489">code »</a></span></h3><p>Removes a data stored under a given key. Will trigger unlock() and ask for
a passphrase if needed. Errback will be triggerred if unlocking failed
(e.g. when user returned an error from the passphrase callback).</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>key<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a></code></dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined">undefined</a>&gt;</code><dd><p>Result ready when the data is
persisted.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="removeMultiple" class="function"><div><h3>removeMultiple(<wbr>keys)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l505">code »</a></span></h3><p>Removes a data stored under multiple keys. Will trigger unlock() and ask for
a passphrase if needed. Errback will be triggerred if unlocking failed
(e.g. when user returned an error from the passphrase callback).</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>keys<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array">Array</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>&gt;</code></dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined">undefined</a>&gt;</code><dd><p>Result ready when the data is
persisted.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="set" class="function"><div><h3>set(<wbr>key, value)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l523">code »</a></span></h3><p>Sets a data stored under a given key. Will trigger unlock() and ask for
a passphrase if needed.</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>key<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a></code><dt>value<code>*</code></dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined">undefined</a>&gt;</code><dd><p>Result ready when the data is
persisted.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="setMultiple" class="function"><div><h3>setMultiple(<wbr>values)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l538">code »</a></span></h3><p>Sets a data into persistent storage. Will trigger unlock() and ask for
a passphrase if needed.</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>values<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object">Object</a></code><dd><p>Object containing all values to persist.</p>
</dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Undefined">undefined</a>&gt;</code><dd><p>Result ready when the data is
persisted.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="setPassphrase" class="function"><div><h3>setPassphrase(<wbr>passphrase)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l432">code »</a></span></h3><p>Encrypts the data in persistent storage with a key derived from a given
passphrase. If the passphrase is an empty string, the storage will be
unencrypted. To protect the caller from destroying the data, LockableStorage
needs to be unlocked at the time of calling this method.</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>passphrase<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a></code><dd><p>The new passphrase.</p>
</dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean">boolean</a>&gt;</code><dd><p>Is the storage encrypted after changing
the passphrase.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="setPassphraseCallback" class="function"><div><h3>setPassphraseCallback(<wbr>passphraseCallback)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l201">code »</a></span></h3><p>Sets the passphrase callback.</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>passphraseCallback<code>function(): <a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>&gt;</code></dl></div></div></div></div><hr class="fn-sep"><div id="unlock" class="function"><div><h3>unlock()<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l554">code »</a></span></h3><p>Tries to unlock the storage mechanism. If needed, this will trigger
passphrase callbacks until a correct passphrase has been given.</p>
<div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a></code><dd><p>The result resolved after the storage is
successfully unlocked.</p>
</dl></div></div></div></div><hr class="fn-sep"><div id="unlockWithPassphrase" class="function"><div><h3>unlockWithPassphrase(<wbr>passphraseTry)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l571">code »</a></span></h3><p>Tries to unlock the storage mechanism once with a given passphrase. If the
passphrase is correct (or the storage is already unlocked), success callback
will be called. If the passphrase is incorrect, errback will be called
instead.</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>passphraseTry<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a></code></dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a></code></dl></div></div></div></div><h2>Static Functions</h2><div id="LockableStorage.launch" class="function"><div><h3>LockableStorage.launch(<wbr>storageMechanism, opt_passphraseCallback, opt_storageKeyName, opt_saltKeyName)<span class="codelink"><a href="source/src/javascript/crypto/e2e/openpgp/lockablestorage.js.src.html#l120">code »</a></span></h3><p>Returns a result that will be resolved with the LockableStorage when the
underlying storage has been read from. Use this to avoid race conditions that
the constructor may introduce.</p>
<div><div class="fn-details"><div><b>Parameters</b></div><dl><dt>storageMechanism<code>goog.storage.mechanism.Mechanism</code><dd><p>persistent
storage mechanism.</p>
<dt>opt_passphraseCallback<code>function(): <a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>&gt;=</code><dd><p>Callback used to deliver the passphrase.</p>
<dt>opt_storageKeyName<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>=</code><dd><p>The storage&#39;s key under which the user
data is stored in storageMechanism.</p>
<dt>opt_saltKeyName<code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">string</a>=</code><dd><p>The storage&#39;s key under which the salt is
stored in storageMechanism.</p>
</dl></div><div class="fn-details"><div><b>Returns</b></div><dl><dt><code><a href="class_e2e_async_Result.html">e2e.async.Result</a>&lt;<a href="class_e2e_openpgp_LockableStorage.html">e2e.openpgp.LockableStorage</a>&gt;</code><dd><p>The storage ready
to be used (check if it needs unlocking with isLocked()).</p>
</dl></div></div></div></div></article><nav><h3><a href="index.html" tabindex="2">Overview</a></h3><div><input type="checkbox" id="nav-types" checked/><label for="nav-types"><h3><span class="selectable" tabindex="2">Types</span></h3></label><div id="nav-types-view"></div></div></nav></main><footer><div><a href="https://github.com/jleyba/js-dossier">Generated by dossier</a></div></footer><script src="types.js"></script><script src="dossier.js"></script>